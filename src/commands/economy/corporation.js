import { SlashCommandBuilder, ActionRowBuilder, StringSelectMenuBuilder, ButtonBuilder, ButtonStyle, PermissionFlagsBits } from 'discord.js';
import { EmbedCreator } from '../../utils/embedCreator.js';
import { createBusinessTables } from '../../db/business-schema.js';

export default {
  data: new SlashCommandBuilder()
    .setName('corporation')
    .setDescription('Syst√®me avanc√© de gestion d\'entreprise')
    .addSubcommand(subcommand =>
      subcommand
        .setName('cr√©er')
        .setDescription('Cr√©er une nouvelle entreprise')
        .addStringOption(option =>
          option
            .setName('nom')
            .setDescription('Nom de votre entreprise')
            .setRequired(true)
        )
        .addStringOption(option =>
          option
            .setName('type')
            .setDescription('Type d\'entreprise')
            .setRequired(true)
            .addChoices(
              { name: 'üíª Entreprise Tech', value: 'tech_company' },
              { name: '‚õèÔ∏è Exploitation Mini√®re Crypto', value: 'crypto_mining' },
              { name: 'üöú Ferme', value: 'farm' },
              { name: 'üçé Verger', value: 'orchard' },
              { name: 'üå∏ Fleuriste', value: 'flower_shop' },
              { name: 'üè≠ Usine', value: 'factory' },
              { name: '‚öíÔ∏è Soci√©t√© Mini√®re', value: 'mining_company' },
              { name: 'üçî Restaurant', value: 'restaurant' },
              { name: 'üè® H√¥tel', value: 'hotel' }
            )
        )
        .addStringOption(option =>
          option
            .setName('description')
            .setDescription('Description de votre entreprise')
            .setRequired(false)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('info')
        .setDescription('Afficher les informations de votre entreprise')
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('collecter')
        .setDescription('Collecter les revenus de votre entreprise')
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('acheter')
        .setDescription('Acheter un actif pour votre entreprise')
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('upgrade')
        .setDescription('Am√©liorer un actif de votre entreprise')
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('membres')
        .setDescription('G√©rer les membres de votre entreprise')
        .addUserOption(option =>
          option
            .setName('utilisateur')
            .setDescription('L\'utilisateur √† g√©rer (optionnel)')
            .setRequired(false)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('embaucher')
        .setDescription('Embaucher un nouvel employ√©')
        .addUserOption(option =>
          option
            .setName('utilisateur')
            .setDescription('L\'utilisateur √† embaucher')
            .setRequired(true)
        )
        .addStringOption(option =>
          option
            .setName('r√¥le')
            .setDescription('R√¥le dans l\'entreprise')
            .setRequired(true)
            .addChoices(
              { name: 'üë®‚Äçüíº Manager', value: 'manager' },
              { name: 'üë§ Employ√©', value: 'employee' }
            )
        )
        .addIntegerOption(option =>
          option
            .setName('salaire')
            .setDescription('Salaire journalier en PiloCoins')
            .setRequired(true)
            .setMinValue(10)
            .setMaxValue(10000)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('licencier')
        .setDescription('Licencier un employ√©')
        .addUserOption(option =>
          option
            .setName('utilisateur')
            .setDescription('L\'utilisateur √† licencier')
            .setRequired(true)
        )
        .addStringOption(option =>
          option
            .setName('raison')
            .setDescription('Raison du licenciement')
            .setRequired(false)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('transactions')
        .setDescription('Voir l\'historique des transactions de votre entreprise')
        .addIntegerOption(option =>
          option
            .setName('limite')
            .setDescription('Nombre de transactions √† afficher')
            .setRequired(false)
            .setMinValue(1)
            .setMaxValue(20)
        )
    )
    .addSubcommand(subcommand =>
      subcommand
        .setName('permissions')
        .setDescription('G√©rer les permissions des r√¥les dans votre entreprise')
        .addStringOption(option =>
          option
            .setName('r√¥le')
            .setDescription('R√¥le √† modifier')
            .setRequired(true)
            .addChoices(
              { name: 'üë®‚Äçüíº Manager', value: 'manager' },
              { name: 'üë§ Employ√©', value: 'employee' }
            )
        )
    )
    .addSubcommandGroup(group =>
      group
        .setName('liste')
        .setDescription('Lister diff√©rentes informations')
        .addSubcommand(subcommand =>
          subcommand
            .setName('entreprises')
            .setDescription('Liste des entreprises publiques')
        )
        .addSubcommand(subcommand =>
          subcommand
            .setName('actifs')
            .setDescription('Liste des actifs disponibles pour votre entreprise')
        )
    ),
  
  // No cooldown for most operations
  cooldown: 0,
  
  async execute(interaction, client) {
    try {
      // S'assurer que les tables d'entreprise existent
      if (!client.businessInitialized) {
        await createBusinessTables(client.db.db);
        
        // Initialiser le gestionnaire d'entreprise s'il n'existe pas d√©j√†
        if (!client.businessManager) {
          const { BusinessManager } = await import('../../utils/businessManager.js');
          client.businessManager = new BusinessManager(client);
          await client.businessManager.initialize();
        }
        
        client.businessInitialized = true;
      }
      
      const manager = client.businessManager;
      const subcommand = interaction.options.getSubcommand();
      const group = interaction.options.getSubcommandGroup(false);
      const userId = interaction.user.id;
      
      // Liste des commandes qui peuvent √™tre utilis√©es sans avoir une entreprise
      const publicCommands = ['cr√©er', 'entreprises'];
      
      // R√©cup√©rer l'entreprise de l'utilisateur pour les commandes non-publiques
      let business = null;
      
      if (!publicCommands.includes(subcommand)) {
        business = await manager.getUserBusiness(userId);
        
        if (!business && group !== 'liste') {
          return interaction.reply({
            embeds: [
              EmbedCreator.warning(
                'Pas d\'entreprise',
                'Vous ne poss√©dez pas d\'entreprise. Utilisez `/corporation cr√©er` pour en cr√©er une.'
              )
            ],
            ephemeral: true
          });
        }
      }
      
      // Traiter les diff√©rentes sous-commandes
      if (subcommand === 'cr√©er') {
        await interaction.deferReply();
        
        const name = interaction.options.getString('nom');
        const type = interaction.options.getString('type');
        const description = interaction.options.getString('description');
        
        // V√©rifier si l'utilisateur a d√©j√† une entreprise
        const existingBusiness = await manager.getUserBusiness(userId);
        
        if (existingBusiness) {
          return interaction.editReply({
            embeds: [
              EmbedCreator.warning(
                'Entreprise existante',
                `Vous poss√©dez d√©j√† une entreprise : ${existingBusiness.name}. Vous devez d'abord la dissoudre avec \`/corporation dissoudre\` avant d'en cr√©er une nouvelle.`
              )
            ]
          });
        }
        
        // V√©rifier le niveau de l'utilisateur
        const user = await client.db.getUser(userId);
        const requiredLevel = manager.types[type].creation_level;
        
        if (user.level < requiredLevel) {
          return interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Niveau requis',
                `Vous devez √™tre niveau ${requiredLevel} pour cr√©er une entreprise de type ${manager.types[type].name}. Vous √™tes actuellement niveau ${user.level}.`
              )
            ]
          });
        }
        
        // V√©rifier si l'utilisateur a assez de PiloCoins
        const creationCost = manager.types[type].base_capital;
        
        if (user.balance < creationCost) {
          return interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Fonds insuffisants',
                `Vous avez besoin de ${creationCost} PiloCoins pour cr√©er cette entreprise (vous avez ${user.balance} PiloCoins).`
              )
            ]
          });
        }
        
        // Cr√©er l'entreprise
        try {
          const newBusiness = await manager.createBusiness(userId, name, type, 0);
          
          // Mettre √† jour la description si fournie
          if (description) {
            await client.db.db.run(`
              UPDATE businesses 
              SET description = ? 
              WHERE id = ?
            `, description, newBusiness.id);
            
            newBusiness.description = description;
          }
          
          // G√©n√©rer l'embed d'information
          const embed = await manager.createBusinessEmbed(newBusiness, true, false, false);
          
          // Ajouter des informations suppl√©mentaires
          embed.addFields({
            name: 'üöÄ D√©marrage',
            value: 'Utilisez `/corporation acheter` pour acqu√©rir vos premiers actifs et commencer √† g√©n√©rer des revenus!',
            inline: false
          });
          
          await interaction.editReply({
            embeds: [embed]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur de cr√©ation',
                `Une erreur est survenue lors de la cr√©ation de l'entreprise : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'info') {
        await interaction.deferReply();
        
        try {
          // G√©n√©rer l'embed d'information complet
          const embed = await manager.createBusinessEmbed(business, true, true, true);
          
          await interaction.editReply({
            embeds: [embed]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'collecter') {
        await interaction.deferReply();
        
        try {
          // V√©rifier les permissions
          const hasPermission = await manager.checkPermission(business.id, userId, 'can_collect');
          
          if (!hasPermission) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.error(
                  'Permission refus√©e',
                  'Vous n\'avez pas la permission de collecter les revenus de cette entreprise.'
                )
              ]
            });
          }
          
          // Collecter les revenus
          const result = await manager.collectRevenue(business.id, userId);
          
          // Cr√©er l'embed de r√©sultat
          const embed = EmbedCreator.success(
            'üí∞ Revenus collect√©s',
            `Vous avez collect√© **${Math.floor(result.netRevenue)}** PiloCoins de revenus g√©n√©r√©s par votre entreprise sur ${result.hoursSinceCollection.toFixed(1)} heures.`,
            {
              fields: [
                {
                  name: 'üìà Revenus bruts',
                  value: `${Math.floor(result.revenue)} PiloCoins`,
                  inline: true
                },
                {
                  name: 'üîß Co√ªts de maintenance',
                  value: `${Math.floor(result.maintenanceCosts)} PiloCoins`,
                  inline: true
                },
                {
                  name: 'üë®‚Äçüíº Salaires',
                  value: `${Math.floor(result.salaryCosts)} PiloCoins`,
                  inline: true
                },
                {
                  name: 'üí∞ Revenus nets',
                  value: `${Math.floor(result.netRevenue)} PiloCoins`,
                  inline: true
                }
              ]
            }
          );
          
          await interaction.editReply({
            embeds: [embed]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'acheter') {
        // V√©rifier les permissions
        const hasPermission = await manager.checkPermission(business.id, userId, 'can_upgrade');
        
        if (!hasPermission) {
          return interaction.reply({
            embeds: [
              EmbedCreator.error(
                'Permission refus√©e',
                'Vous n\'avez pas la permission d\'acheter des actifs pour cette entreprise.'
              )
            ],
            ephemeral: true
          });
        }
        
        // R√©cup√©rer les actifs disponibles pour ce type d'entreprise
        const availableAssets = manager.types[business.type].available_assets;
        const assetOptions = availableAssets.map(assetType => {
          const asset = manager.assetTypes[assetType];
          return {
            label: asset.name,
            value: assetType,
            description: `${asset.base_cost} PiloCoins - ${asset.base_production} prod/h`,
            emoji: asset.emoji
          };
        });
        
        // Cr√©er le menu de s√©lection
        const selectMenu = new ActionRowBuilder()
          .addComponents(
            new StringSelectMenuBuilder()
              .setCustomId(`corp:asset:${business.id}`)
              .setPlaceholder('S√©lectionnez un actif √† acheter')
              .addOptions(assetOptions)
          );
        
        // Cr√©er l'embed explicatif
        const embed = EmbedCreator.create({
          title: 'üõí Achat d\'actifs',
          description: `S√©lectionnez un actif √† acheter pour votre entreprise **${business.name}**.\n\nVous disposez de **${business.capital}** PiloCoins de capital d'entreprise.`,
          color: 'PRIMARY',
          fields: [
            {
              name: 'üíº Capital disponible',
              value: `${business.capital} PiloCoins`,
              inline: true
            },
            {
              name: 'üìä Niveau d\'entreprise',
              value: `${business.level}/5`,
              inline: true
            }
          ]
        });
        
        await interaction.reply({
          embeds: [embed],
          components: [selectMenu]
        });
      }
      
      else if (subcommand === 'upgrade') {
        // V√©rifier les permissions
        const hasPermission = await manager.checkPermission(business.id, userId, 'can_upgrade');
        
        if (!hasPermission) {
          return interaction.reply({
            embeds: [
              EmbedCreator.error(
                'Permission refus√©e',
                'Vous n\'avez pas la permission d\'am√©liorer des actifs pour cette entreprise.'
              )
            ],
            ephemeral: true
          });
        }
        
        // R√©cup√©rer les actifs de l'entreprise
        const assets = await manager.getBusinessAssets(business.id);
        
        if (assets.length === 0) {
          return interaction.reply({
            embeds: [
              EmbedCreator.warning(
                'Aucun actif',
                'Votre entreprise ne poss√®de aucun actif √† am√©liorer. Utilisez `/corporation acheter` pour acqu√©rir des actifs.'
              )
            ],
            ephemeral: true
          });
        }
        
        // Filtrer les actifs qui ne sont pas au niveau maximum
        const upgradableAssets = assets.filter(asset => {
          const assetType = manager.assetTypes[asset.asset_type];
          return asset.level < assetType.max_level;
        });
        
        if (upgradableAssets.length === 0) {
          return interaction.reply({
            embeds: [
              EmbedCreator.warning(
                'Niveau maximum',
                'Tous vos actifs sont d√©j√† au niveau maximum.'
              )
            ],
            ephemeral: true
          });
        }
        
        // Cr√©er les options pour le menu
        const assetOptions = upgradableAssets.map(asset => {
          const assetType = manager.assetTypes[asset.asset_type];
          const upgradeCost = assetType.base_cost * Math.pow(2, asset.level) * asset.quantity;
          
          return {
            label: `${asset.name} (Niv. ${asset.level}/${assetType.max_level})`,
            value: `${asset.id}`,
            description: `Co√ªt: ${upgradeCost} PiloCoins`,
            emoji: assetType.emoji
          };
        });
        
        // Cr√©er le menu de s√©lection
        const selectMenu = new ActionRowBuilder()
          .addComponents(
            new StringSelectMenuBuilder()
              .setCustomId(`corp:upgrade:${business.id}`)
              .setPlaceholder('S√©lectionnez un actif √† am√©liorer')
              .addOptions(assetOptions)
          );
        
        // Cr√©er l'embed explicatif
        const embed = EmbedCreator.create({
          title: '‚¨ÜÔ∏è Am√©lioration d\'actifs',
          description: `S√©lectionnez un actif √† am√©liorer pour votre entreprise **${business.name}**.\n\nVous disposez de **${business.capital}** PiloCoins de capital d'entreprise.`,
          color: 'PRIMARY',
          fields: [
            {
              name: 'üíº Capital disponible',
              value: `${business.capital} PiloCoins`,
              inline: true
            },
            {
              name: 'üìä Niveau d\'entreprise',
              value: `${business.level}/5`,
              inline: true
            }
          ]
        });
        
        await interaction.reply({
          embeds: [embed],
          components: [selectMenu]
        });
      }
      
      else if (subcommand === 'membres') {
        await interaction.deferReply();
        
        try {
          // R√©cup√©rer les membres de l'entreprise
          const members = await manager.getBusinessMembers(business.id);
          
          // G√©n√©rer l'embed
          const embed = EmbedCreator.create({
            title: `üë• Membres de ${business.name}`,
            description: `Votre entreprise compte **${members.length}** membres sur un maximum de **${manager.types[business.type].max_employees}**.`,
            color: 'PRIMARY',
            fields: []
          });
          
          // Regrouper les membres par r√¥le
          const ownerMembers = members.filter(m => m.role === 'owner');
          const managerMembers = members.filter(m => m.role === 'manager');
          const employeeMembers = members.filter(m => m.role === 'employee');
          
          if (ownerMembers.length > 0) {
            const ownersText = ownerMembers.map(m => `üëë <@${m.user_id}> - ${m.salary} PiloCoins/jour`).join('\n');
            
            embed.addFields({
              name: 'üëë Propri√©taire',
              value: ownersText,
              inline: false
            });
          }
          
          if (managerMembers.length > 0) {
            const managersText = managerMembers.map(m => `üî± <@${m.user_id}> - ${m.salary} PiloCoins/jour`).join('\n');
            
            embed.addFields({
              name: 'üî± Managers',
              value: managersText,
              inline: false
            });
          }
          
          if (employeeMembers.length > 0) {
            const employeesText = employeeMembers.map(m => `üë§ <@${m.user_id}> - ${m.salary} PiloCoins/jour`).join('\n');
            
            embed.addFields({
              name: 'üë§ Employ√©s',
              value: employeesText,
              inline: false
            });
          }
          
          // Ajouter des boutons de gestion si l'utilisateur est propri√©taire
          const isOwner = ownerMembers.some(m => m.user_id === userId);
          let components = [];
          
          if (isOwner) {
            const buttons = new ActionRowBuilder()
              .addComponents(
                new ButtonBuilder()
                  .setCustomId(`corp:embaucher:${business.id}`)
                  .setLabel('Embaucher')
                  .setStyle(ButtonStyle.Success)
                  .setEmoji('üë®‚Äçüíº'),
                new ButtonBuilder()
                  .setCustomId(`corp:licencier:${business.id}`)
                  .setLabel('Licencier')
                  .setStyle(ButtonStyle.Danger)
                  .setEmoji('üö´'),
                new ButtonBuilder()
                  .setCustomId(`corp:salaire:${business.id}`)
                  .setLabel('Changer salaire')
                  .setStyle(ButtonStyle.Primary)
                  .setEmoji('üí∞')
              );
            
            components = [buttons];
          }
          
          await interaction.editReply({
            embeds: [embed],
            components: components
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'embaucher') {
        await interaction.deferReply();
        
        try {
          const targetUser = interaction.options.getUser('utilisateur');
          const role = interaction.options.getString('r√¥le');
          const salary = interaction.options.getInteger('salaire');
          
          // V√©rifier les permissions
          const hasPermission = await manager.checkPermission(business.id, userId, 'can_hire');
          
          if (!hasPermission) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.error(
                  'Permission refus√©e',
                  'Vous n\'avez pas la permission d\'embaucher des employ√©s dans cette entreprise.'
                )
              ]
            });
          }
          
          // Embaucher l'employ√©
          await manager.hireEmployee(business.id, targetUser.id, role, salary, userId);
          
          await interaction.editReply({
            embeds: [
              EmbedCreator.success(
                'üë®‚Äçüíº Employ√© embauch√©',
                `<@${targetUser.id}> a √©t√© embauch√© comme ${role === 'manager' ? 'manager' : 'employ√©'} avec un salaire de ${salary} PiloCoins/jour.`
              )
            ]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'licencier') {
        await interaction.deferReply();
        
        try {
          const targetUser = interaction.options.getUser('utilisateur');
          const reason = interaction.options.getString('raison') || 'Aucune raison sp√©cifi√©e';
          
          // V√©rifier les permissions
          const hasPermission = await manager.checkPermission(business.id, userId, 'can_fire');
          
          if (!hasPermission) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.error(
                  'Permission refus√©e',
                  'Vous n\'avez pas la permission de licencier des employ√©s dans cette entreprise.'
                )
              ]
            });
          }
          
          // Licencier l'employ√©
          await manager.fireEmployee(business.id, targetUser.id, userId, reason);
          
          await interaction.editReply({
            embeds: [
              EmbedCreator.success(
                'üö´ Employ√© licenci√©',
                `<@${targetUser.id}> a √©t√© licenci√© de l'entreprise.\nRaison : ${reason}`
              )
            ]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'transactions') {
        await interaction.deferReply();
        
        try {
          const limit = interaction.options.getInteger('limite') || 10;
          
          // V√©rifier les permissions
          const hasPermission = await manager.checkPermission(business.id, userId, 'can_view_finances');
          
          if (!hasPermission) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.error(
                  'Permission refus√©e',
                  'Vous n\'avez pas la permission de consulter les finances de cette entreprise.'
                )
              ]
            });
          }
          
          // R√©cup√©rer les transactions
          const transactions = await manager.getBusinessTransactions(business.id, limit);
          
          // Cr√©er l'embed
          const embed = EmbedCreator.create({
            title: `üìí Transactions de ${business.name}`,
            description: `Les ${limit} derni√®res transactions de votre entreprise.`,
            color: 'PRIMARY',
            fields: []
          });
          
          if (transactions.length === 0) {
            embed.setDescription('Aucune transaction enregistr√©e pour cette entreprise.');
          } else {
            let transactionsText = '';
            
            for (const tx of transactions) {
              const amountText = tx.amount >= 0 ? `+${tx.amount}` : `${tx.amount}`;
              const date = new Date(tx.created_at).toLocaleDateString();
              const time = new Date(tx.created_at).toLocaleTimeString();
              transactionsText += `${date} ${time}: **${amountText}** PiloCoins - ${tx.description}\n`;
            }
            
            embed.addFields({
              name: 'üìù Historique',
              value: transactionsText,
              inline: false
            });
          }
          
          await interaction.editReply({
            embeds: [embed]
          });
        } catch (error) {
          await interaction.editReply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                `Une erreur est survenue : ${error.message}`
              )
            ]
          });
        }
      }
      
      else if (subcommand === 'permissions') {
        // Cette sous-commande g√®re les permissions des r√¥les
        const role = interaction.options.getString('r√¥le');
        
        // V√©rifier si l'utilisateur est le propri√©taire
        const members = await manager.getBusinessMembers(business.id);
        const isOwner = members.some(m => m.user_id === userId && m.role === 'owner');
        
        if (!isOwner) {
          return interaction.reply({
            embeds: [
              EmbedCreator.error(
                'Permission refus√©e',
                'Seul le propri√©taire peut modifier les permissions des r√¥les.'
              )
            ],
            ephemeral: true
          });
        }
        
        // R√©cup√©rer les permissions actuelles
        const permissions = await client.db.db.get(`
          SELECT * FROM business_permissions
          WHERE business_id = ? AND role = ?
        `, business.id, role);
        
        if (!permissions) {
          return interaction.reply({
            embeds: [
              EmbedCreator.error(
                'Erreur',
                'Impossible de r√©cup√©rer les permissions pour ce r√¥le.'
              )
            ],
            ephemeral: true
          });
        }
        
        // Cr√©er les boutons pour chaque permission
        const createPermissionButton = (permName, permValue, emoji, label) => {
          return new ButtonBuilder()
            .setCustomId(`corp:perm:${business.id}:${role}:${permName}`)
            .setLabel(label)
            .setStyle(permValue ? ButtonStyle.Success : ButtonStyle.Secondary)
            .setEmoji(emoji);
        };
        
        // Premi√®re rang√©e de boutons
        const row1 = new ActionRowBuilder()
          .addComponents(
            createPermissionButton('can_hire', permissions.can_hire, 'üë®‚Äçüíº', 'Embaucher'),
            createPermissionButton('can_fire', permissions.can_fire, 'üö´', 'Licencier'),
            createPermissionButton('can_collect', permissions.can_collect, 'üí∞', 'Collecter')
          );
        
        // Deuxi√®me rang√©e de boutons
        const row2 = new ActionRowBuilder()
          .addComponents(
            createPermissionButton('can_upgrade', permissions.can_upgrade, '‚¨ÜÔ∏è', 'Am√©liorer'),
            createPermissionButton('can_withdraw', permissions.can_withdraw, 'üí∏', 'Retirer'),
            createPermissionButton('can_deposit', permissions.can_deposit, 'üíµ', 'D√©poser')
          );
        
        // Troisi√®me rang√©e de boutons
        const row3 = new ActionRowBuilder()
          .addComponents(
            createPermissionButton('can_change_salary', permissions.can_change_salary, 'üí≤', 'Modifier salaires'),
            createPermissionButton('can_change_settings', permissions.can_change_settings, '‚öôÔ∏è', 'Param√®tres'),
            createPermissionButton('can_view_finances', permissions.can_view_finances, 'üìä', 'Voir finances')
          );
        
        // Cr√©er l'embed
        const embed = EmbedCreator.create({
          title: `‚öôÔ∏è Permissions : ${role}`,
          description: `G√©rez les permissions pour le r√¥le **${role}** dans votre entreprise. Cliquez sur un bouton pour activer/d√©sactiver une permission.`,
          color: 'PRIMARY',
          fields: [
            {
              name: 'üë®‚Äçüíº Embaucher',
              value: permissions.can_hire ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üö´ Licencier',
              value: permissions.can_fire ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üí∞ Collecter',
              value: permissions.can_collect ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: '‚¨ÜÔ∏è Am√©liorer',
              value: permissions.can_upgrade ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üí∏ Retirer',
              value: permissions.can_withdraw ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üíµ D√©poser',
              value: permissions.can_deposit ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üí≤ Modifier salaires',
              value: permissions.can_change_salary ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: '‚öôÔ∏è Param√®tres',
              value: permissions.can_change_settings ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            },
            {
              name: 'üìä Voir finances',
              value: permissions.can_view_finances ? '‚úÖ Activ√©' : '‚ùå D√©sactiv√©',
              inline: true
            }
          ]
        });
        
        await interaction.reply({
          embeds: [embed],
          components: [row1, row2, row3]
        });
      }
      
      // --- Sous-commandes du groupe "liste" ---
      else if (group === 'liste') {
        if (subcommand === 'entreprises') {
          await interaction.deferReply();
          
          // R√©cup√©rer les entreprises publiques
          const businesses = await client.db.db.all(`
            SELECT * FROM businesses
            WHERE public = 1
            ORDER BY level DESC, capital DESC
            LIMIT 10
          `);
          
          if (businesses.length === 0) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.info(
                  'üè¢ Entreprises',
                  'Aucune entreprise publique n\'a √©t√© trouv√©e.'
                )
              ]
            });
          }
          
          // Cr√©er l'embed
          const embed = EmbedCreator.create({
            title: 'üè¢ Entreprises publiques',
            description: 'Liste des 10 entreprises les plus importantes.',
            color: 'PRIMARY',
            fields: []
          });
          
          // Ajouter chaque entreprise
          for (const business of businesses) {
            const businessType = manager.types[business.type];
            const emoji = businessType ? businessType.emoji : 'üè¢';
            
            embed.addFields({
              name: `${emoji} ${business.name} (Niv. ${business.level})`,
              value: `Type: ${businessType ? businessType.name : business.type}\nCapital: ${business.capital} PiloCoins\nPropri√©taire: <@${business.owner_id}>`,
              inline: true
            });
          }
          
          await interaction.editReply({
            embeds: [embed]
          });
        }
        
        else if (subcommand === 'actifs') {
          await interaction.deferReply();
          
          // R√©cup√©rer les actifs de l'entreprise
          const assets = await manager.getBusinessAssets(business.id);
          
          // R√©cup√©rer les actifs disponibles pour ce type d'entreprise
          const availableAssetTypes = manager.types[business.type].available_assets;
          
          if (assets.length === 0) {
            return interaction.editReply({
              embeds: [
                EmbedCreator.info(
                  'üè≠ Actifs',
                  `Votre entreprise ne poss√®de aucun actif. Utilisez \`/corporation acheter\` pour acqu√©rir des actifs.`
                )
              ]
            });
          }
          
          // Cr√©er l'embed
          const embed = EmbedCreator.create({
            title: `üè≠ Actifs de ${business.name}`,
            description: `Liste des actifs de votre entreprise et des actifs disponibles √† l'achat.`,
            color: 'PRIMARY',
            fields: []
          });
          
          // Afficher les actifs poss√©d√©s
          let ownedAssetsText = '';
          
          for (const asset of assets) {
            const assetType = manager.assetTypes[asset.asset_type];
            const emoji = assetType ? assetType.emoji : 'üîß';
            const production = Math.round(asset.base_production * (asset.efficiency / 100) * asset.quantity * Math.pow(assetType.upgrade_multiplier, asset.level - 1));
            
            ownedAssetsText += `${emoji} **${asset.name}** (Niv. ${asset.level}/${assetType.max_level}) x${asset.quantity}\n`;
            ownedAssetsText += `   Production: ${production} PiloCoins/h\n`;
            ownedAssetsText += `   Entretien: ${asset.maintenance_cost} PiloCoins/h\n\n`;
          }
          
          embed.addFields({
            name: 'üîß Actifs poss√©d√©s',
            value: ownedAssetsText || 'Aucun actif',
            inline: false
          });
          
          // Afficher les actifs disponibles √† l'achat
          let availableAssetsText = '';
          
          for (const assetType of availableAssetTypes) {
            const asset = manager.assetTypes[assetType];
            if (!asset) continue;
            
            const alreadyOwned = assets.some(a => a.asset_type === assetType);
            const emoji = asset.emoji;
            
            availableAssetsText += `${emoji} **${asset.name}**${alreadyOwned ? ' (Poss√©d√©)' : ''}\n`;
            availableAssetsText += `   Prix: ${asset.base_cost} PiloCoins\n`;
            availableAssetsText += `   Production: ${asset.base_production} PiloCoins/h\n`;
            availableAssetsText += `   Entretien: ${asset.maintenance_cost} PiloCoins/h\n\n`;
          }
          
          embed.addFields({
            name: 'üõí Actifs disponibles',
            value: availableAssetsText || 'Aucun actif disponible',
            inline: false
          });
          
          await interaction.editReply({
            embeds: [embed]
          });
        }
      }
      
    } catch (error) {
      console.error('Error in corporation command:', error);
      
      // Send error message
      const errorEmbed = EmbedCreator.error(
        'Erreur',
        'Une erreur est survenue lors de l\'ex√©cution de la commande.'
      );
      
      if (interaction.deferred) {
        await interaction.editReply({ embeds: [errorEmbed] });
      } else {
        await interaction.reply({ embeds: [errorEmbed], ephemeral: true });
      }
    }
  }
};